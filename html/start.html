<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/png" href="../images/icon.png"> 
    <link rel="stylesheet" href="../css/animate.css">
    <link rel="stylesheet" href="../css/common.style.css">
    <link rel="stylesheet" href="../css/start.style.css">
    <title>象棋記憶大賽 V2</title>
</head>
<body>
  <div class="top">
    <img id="skill" src="../images/skill.png">
    <div class="score">
      <span>0</span>
    </div>
    <div id="timer">00:00</div>
    <div class="score">
      <span>0</span>
    </div>
    <img id="rule" src="../images/rule1.png">
  </div>
  <div class="name">
    <div>
      <span>玩家姓名</span>
    </div>
    <div>
      <span>電腦姓名</span>
    </div>
  </div>
  <div class="info">
    <div class="picture">
      <img src="../images/player1.png">
      <span class="skill-name disappear"></span>
    </div>
    <div class="picture">
      <img src="../images/robot1.png">
      <span class="skill-name disappear"></span>
    </div>
  </div>
  <div class="chess-board">
    <table id="board"></table>
  </div>
</body>
<script src="../js/jquery-3.7.1.min.js"></script>
<script src="../js/jquery.lettering.js"></script>
<script src="../js/jquery.textillate.js"></script>
<script src="../js/sweetalert2@11.js"></script>
<script type="module">
  import { pathName, randNumberWithMin, getSkillInfo, redirectToHome, serverError } from "../js/common.js"
  import { timeTo } from "../js/timer.js"
  import { showSkillEffect, activateEnemySkill, isPlayerMoveAgain, isEnemyMoveAgain, setIsMoveAgain } from "../js/start.js"
  import { setChessBoardStore, getChessBoardStore, getPlayerInfo, getEnemyInfo,
          setPlayerScore, setEnemyScore, getActivateSkill, setActivateSkill,
          getAction, setAction, getOpenChess, setOpenChess,
          insertPlayer } from "../js/store.js"

  let flipNumbers = []

  $(function () {
    history.replaceState(null, "", pathName)
    
    initChessBoard()
    initRoleInfo()

    if ($(".chess").length == 0) {
      timeTo("gameOver")
      gameOver()
    } else {
      timeTo()
    }

    $(".chess").on("click", clickChess)

    $("#skill").on("click", async () => {
      timeTo("stop")
      const playerInfo = getPlayerInfo()
      const skillInfo = await getSkillInfo(playerInfo.id)
      Swal.fire({
        title: "確定要發動技能嗎?",
        html: `<div class="skill-info">
                <p>技能:${skillInfo.skill}</p>
                <p>${skillInfo.desc}</p>
              </div>`,
        icon: "warning",
        showCancelButton: true,
        reverseButtons: true,
        allowOutsideClick: false,
        confirmButtonText: "確定",
        cancelButtonText: "取消"
      }).then( async (result) => {
        if (result.value) { 
          $("#skill").addClass("activated")
          showSkillEffect(playerInfo.id)
          setActivateSkill(true)
        }
        timeTo()
      })
    })

    $("#rule").on("click", function () {
      timeTo("stop")
      Swal.fire({
        allowOutsideClick: false,
        html: `<h1>遊戲規則</h1>
              <h2>翻開兩顆相同圖案及顏色或</h2>
              <h2>相同圖案不同顏色的象棋</h2>
              <h2>象棋抵銷後可繼續行動</h2>
              <div>
                <img class="rule" src="${pathName}images/rule.png"/>
              </div>`,
        confirmButtonText: "確定"
      }).then(() => {
        timeTo()
      })
    })
  })

  const initRoleInfo = () => {
    const playerInfo = getPlayerInfo()
    const enemyInfo = getEnemyInfo()

    $(".picture img").eq(0).attr("src", `${pathName}images/player${playerInfo.id}.png`)
    $(".picture img").eq(1).attr("src", `${pathName}images/robot${enemyInfo.id}.png`)

    $(".name span").eq(0).text(playerInfo.name)
    $(".name span").eq(1).text(enemyInfo.name)

    $(".score span").eq(0).text(playerInfo.score)
    $(".score span").eq(1).text(enemyInfo.score)
    
    const index = getAction() ? 0 : 1
    $(".picture").eq(index).addClass("action")
    if (!getAction()) {
      autoFlip()
    }

    if (getActivateSkill().player) {
      $("#skill").addClass("activated")
    }
  }
  
  const initChessBoard = () => {
    var pageWidth = document.documentElement.clientWidth;
    let grids = [4, 8]
    if (pageWidth < 791) {
      grids = [8, 4]
    }
    const chessBoard = getChessBoardStore()
    let chessBoardIndex = 0
    let html = ""
    for (let i = 0; i < grids[0]; i++) {
      html += "<tr>"
      for (let j = 0; j < grids[1]; j++) {
        html += "<td>"
        if (chessBoard.length == 0 || chessBoard[chessBoardIndex] > 0) {
          html += `<div class="chess">
                    <div class="front"></div>
                    <div class="back"></div>
                  </div>`
        }
        html += "</td>"
        chessBoardIndex++
      }
      html += "</tr>"
    }
    $("#board").append(html)

    if (chessBoard.length > 0) {
      for (let i = 0; i < chessBoard.length; i++) {
        let num = chessBoard[i]
        if (num != 0) {
          $("td").eq(i).find(".front").css("background-image", `url(../images/chess${num}.png)`)
          $("td").eq(i).find(".chess").attr("data-image", num)
          if (num == 2) num = 1
          if (num == 13 || num == 14) num = 2
          $("td").eq(i).find(".chess").attr("data-chess", num)
        }
      }

      getOpenChess().forEach(index => {
        clickChess({currentTarget: $(".chess").eq(index)})
      })
    } else {
      let chessNumber = [1, 2]
      const totalChess = $(".chess").length
      
      for (let i = 3; i <= 12; i++) {
        chessNumber.push(i, i)
      }

      for (let i = 0; i < 5; i++) {
        chessNumber.push(13, 14)
      }

      // Fisher–Yates shuffle
      for (let i = totalChess - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [chessNumber[i], chessNumber[j]] = [chessNumber[j], chessNumber[i]]
      }

      for (let i = 0; i < totalChess; i++) {
        let num = chessNumber[i]
        $(".chess").eq(i).find(".front").css("background-image", `url(../images/chess${num}.png)`)
        $(".chess").eq(i).attr("data-image", num)
        if (num == 2) num = 1
        if (num == 13 || num == 14) num = 2
        $(".chess").eq(i).attr("data-chess", num)
      }
    }
    setChessBoardStore()
  }

  const getOpenChessIndex = () => {
    return $(".chess").map((index) => {
      if ($(".chess").eq(index).hasClass("open")) {
        return index
      }
    }).get()
  }

  const clickChess = (event) => {
    const ele = event.currentTarget
    if (flipNumbers.length < 2 && !$(ele).hasClass("open")) {
      flipNumbers.push($(ele).data("chess"))
      $(ele).addClass("open")
      if (getAction()) {
        setOpenChess(getOpenChessIndex())
        if (flipNumbers.length == 2) {
          const isEqual = flipNumbers.every(num => num === flipNumbers[0])
          if (isEqual) {
            $(".open").fadeTo(1000, 0)
            setPlayerScore()

            setTimeout(() => {
              $(".open").remove();
              flipNumbers.length = 0
              setOpenChess()
              setChessBoardStore()
              if ($(".chess").length == 0) {
                gameOver()
              }
            }, 1000)
          } else {
            setTimeout(() => {
              $(".open").removeClass("open")
              flipNumbers.length = 0
              setOpenChess()
              if (isPlayerMoveAgain) {
                setIsMoveAgain(false)
              } else {
                autoFlip()
              }
            }, 1000)
          }
        }
      }
    }
  }

  const gameOver = (async () => {
    timeTo("stop")
    const chess = $(".chess").length
    const playerInfo = getPlayerInfo()
    const enemyInfo = getEnemyInfo()
    if (chess == 0) {
      if (playerInfo.score == enemyInfo.score) {
        await Swal.fire({
          allowOutsideClick: false,
          html: `<div>
                  <img class="over" src="${pathName}images/versus.png"/>
                </div>
                <div class="draw">平手</div>`,
          confirmButtonText: "確定"
        })
      } else if (playerInfo.score < enemyInfo.score) {
        await Swal.fire({
          allowOutsideClick: false,
          html: `<div>
                  <img class="over" src="${pathName}images/game-over.png"/>
                </div>
                <div class="speech-bubble">
                  <div>${enemyInfo.message}</div>
                  <img src="${pathName}images/robot${enemyInfo.id}.png"/>
                </div>`,
          confirmButtonText: "確定"
        })
      } else {
        await Swal.fire({
          allowOutsideClick: false,
          html: `<div>
                    <img class="over" src="${pathName}images/winner.png"/>
                  </div>
                <div class="win-message">
                  <div>
                    <input id="message-input" class="swal2-input" placeholder="你的勝利留言 (可略過)" type="text" maxlength="20">
                  </div>
                  <img src="${pathName}images/player${playerInfo.id}.png"/>
                </div>`,
          confirmButtonText: "確定"
        }).then(async () => {
          const message = $("#message-input").val().trim()
          const result = await insertPlayer(message)
          if (result) {
            if (result?.data?.topFive) {
              Swal.fire({
                html: `<img class="over" src="${pathName}images/brain.png"/>
                        <h2 style="margin-bottom:0">前五名達成！你的記憶力已經無人能忽視！</h2>`,
                allowOutsideClick: false,
                confirmButtonText: "確定"
              }).then(result => {
                redirectToHome()
              })
            } else {
              redirectToHome()
            }
          } else {
            serverError()
          }
        })
      }
    }
  })

  const autoFlip = async () => {
    $(".picture").eq(0).removeClass("action")
    $(".picture").eq(1).addClass("action")
    setAction(false)
    $("img").addClass("disabled")
    $(".chess").addClass("disabled")

    const result = await activateEnemySkill()

    setTimeout(() => {
      let randNumber = []
      while (flipNumbers.length != 2) {
        const randNum = randNumberWithMin(0, $(".chess").length - 1)
        if (randNumber.includes(randNum)) {
          continue
        }

        randNumber.push(randNum)
        const number = $(".chess").eq(randNum).data("chess")
        if (!flipNumbers.includes(number)) {
          flipNumbers.push(number)
          setTimeout(() => {
            $(".chess").eq(randNum).addClass("open")
            setOpenChess(getOpenChessIndex())
          }, flipNumbers.length * 500)
        }
      }

      if(result.reBinding) {
        $(".chess").on("click", clickChess)
      }

      setTimeout(() => {
        const isEqual = flipNumbers.every(num => num === flipNumbers[0])
        if (isEqual) {
          $(".open").fadeTo(1000, 0)
          setEnemyScore()
          
          setTimeout(() => {
            $(".open").remove();
            flipNumbers.length = 0
            setOpenChess()
            setChessBoardStore()

            if ($(".chess").length == 0) {
              gameOver()
            } else {
              autoFlip()
            }
          }, 1000)
        } else {
          if (isEnemyMoveAgain) {
            setIsMoveAgain(false, false)

            setTimeout(() => {
              $(".open").removeClass("open");
              flipNumbers.length = 0
              setOpenChess()
              autoFlip()
            }, 1000)
          } else {
            setTimeout(() => {
              $(".open").removeClass("open")
              flipNumbers.length = 0
              setOpenChess()
              $(".picture").eq(0).addClass("action")
              $(".picture").eq(1).removeClass("action")
              setAction(true)
              $("img").removeClass("disabled")
              $(".chess").removeClass("disabled")
            }, 1000)
          }
        }
      }, 1000)
    }, result.delayTime)
  }
</script>
</html>